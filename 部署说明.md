# 糖尿病患者体检前问卷智能交互小程序 - 部署说明

## 项目概述

本项目是一个基于微信小程序原生开发 + 微信云开发的糖尿病患者体检前问卷智能交互系统。系统包含32道预制问卷题目，支持AI智能交互、数据质量校验、医疗数据安全存储等功能。

## 技术架构

- **前端**: 微信小程序原生（WXML + WXSS + JavaScript）
- **后端**: 微信云开发（云函数 + 云数据库）
- **AI服务**: 智谱AI API（可选）
- **适配**: 375×812基准尺寸，兼容全移动端

## 部署步骤

### 1. 环境准备

#### 1.1 开发工具
- 下载并安装最新版微信开发者工具
- 确保Node.js版本 ≥ 14.0.0

#### 1.2 微信小程序账号
- 注册微信小程序开发者账号
- 完成企业认证（如需使用云开发）

### 2. 项目导入

#### 2.1 下载代码
- 将项目代码下载到本地目录

#### 2.2 导入开发者工具
1. 打开微信开发者工具
2. 选择"导入项目"
3. 选择项目根目录
4. 填写AppID（如无可用测试号）
5. 点击"确定"导入

### 3. 云环境配置

#### 3.1 开通云开发
1. 在开发者工具中点击"云开发"按钮
2. 开通云开发服务
3. 创建云环境（建议选择付费版以获得更好性能）
4. 记录环境ID

#### 3.2 配置云环境ID
在 `app.js` 文件中替换云环境ID：

```javascript
wx.cloud.init({
  env: 'your-cloud-env-id', // 替换为您的云环境ID
  traceUser: true
});
```

### 4. 云函数部署

#### 4.1 安装云函数依赖
```bash
# 进入云函数目录
cd cloudfunctions/init
npm install

cd ../interact
npm install
```

#### 4.2 上传云函数
1. 在开发者工具中右键点击 `cloudfunctions` 文件夹
2. 选择"上传并部署：云端安装依赖"
3. 等待上传完成

#### 4.3 验证云函数
1. 在云开发控制台查看云函数列表
2. 确认 `init` 和 `interact` 函数已上传成功
3. 可以测试调用 `init` 函数验证运行正常

### 5. 数据库初始化

#### 5.1 自动初始化
- 首次调用 `init` 云函数时会自动创建数据库表
- 无需手动操作

#### 5.2 验证数据库
1. 打开云开发控制台
2. 进入数据库管理
3. 确认以下表已创建：
   - `questionnaire`（问卷模板表）
   - `fill_record`（填写记录表）
   - `llm_log`（AI交互日志表）

### 6. LLM API配置（可选）

#### 6.1 获取智谱AI API密钥
1. 访问智谱AI开放平台
2. 注册账号并申请API密钥
3. 获取API Key和Secret

#### 6.2 配置API密钥
**方式一：云函数环境变量**（推荐）
在云开发控制台配置环境变量：
- `ZHIPU_API_KEY`: 您的API Key
- `ZHIPU_API_SECRET`: 您的API Secret

**方式二：代码配置**
在 `cloudfunctions/interact/index.js` 中修改：
```javascript
const ZHIPU_AI_CONFIG = {
  apiKey: 'your-actual-api-key',
  apiSecret: 'your-actual-api-secret',
  baseUrl: 'https://open.bigmodel.cn/api/paas/v4/chat/completions'
};
```

### 7. 本地测试

#### 7.1 编译运行
1. 在开发者工具中点击"编译"
2. 检查控制台是否有错误信息
3. 在模拟器中测试各项功能

#### 7.2 功能测试清单
- [ ] 页面正常加载
- [ ] 问卷题目显示正确
- [ ] 题目切换功能正常
- [ ] 答案保存功能正常
- [ ] AI助手交互正常
- [ ] 提交功能正常
- [ ] 结果页面显示正常

### 8. 真机测试

#### 8.1 预览版本
1. 点击"预览"生成二维码
2. 使用微信扫描测试
3. 在不同设备上测试适配性

#### 8.2 体验版本
1. 上传体验版本
2. 添加体验者微信号
3. 进行多用户测试

### 9. 正式发布

#### 9.1 代码审核
1. 确保代码符合微信小程序规范
2. 处理所有审核可能遇到的问题
3. 提交审核

#### 9.2 发布上线
1. 审核通过后发布正式版
2. 监控运行状态
3. 收集用户反馈

## 配置项说明

### 必须配置项

1. **云环境ID**
   - 位置：`app.js`
   - 说明：微信云开发环境标识

2. **小程序AppID**
   - 位置：`project.config.json`
   - 说明：微信小程序唯一标识

### 可选配置项

1. **LLM API密钥**
   - 位置：云函数环境变量或代码配置
   - 说明：启用智能问答功能

2. **超时时间配置**
   - 位置：各云函数配置
   - 说明：根据业务需求调整

## 故障排除

### 常见问题

#### 1. 云函数调用失败
- 检查云环境ID是否正确
- 确认云函数已成功上传
- 查看云函数日志排查错误

#### 2. 数据库操作失败
- 确认数据库表已自动创建
- 检查数据库权限设置
- 验证数据格式是否正确

#### 3. AI功能不可用
- 检查API密钥配置
- 确认网络连接正常
- 查看降级策略是否生效

#### 4. 页面显示异常
- 检查CSS样式兼容性
- 验证rpx单位转换
- 测试不同屏幕尺寸适配

### 日志查看

1. **云函数日志**：云开发控制台 → 云函数 → 日志
2. **前端日志**：开发者工具 → 控制台
3. **用户反馈**：小程序管理后台 → 用户反馈

## 维护建议

### 定期检查
1. 监控云函数执行情况
2. 检查数据库存储使用量
3. 更新依赖包版本
4. 备份重要数据

### 性能优化
1. 启用云函数并发执行
2. 优化数据库查询索引
3. 压缩静态资源
4. 使用CDN加速

## 技术支持

如遇部署问题，请参考：
1. 微信小程序官方文档
2. 微信云开发文档
3. 项目代码注释
4. GitHub Issues（如有）

---

**最后更新**: 2025年1月7日  
**版本**: v1.0.0  
**技术支持**: 智能医疗问卷系统团队